\chapter{Methods: ``\hotspice'' simulator for ASI}\label{ch:Hotspice}
% \glijbaantje{It's not a bug, it's a feature.}{Someone}

\begin{adjustwidth}{2em}{2em} % TODO END: update once published.
    \begin{center}
        \textbf{Material from this chapter has also been published in:} \\
    \end{center}
    \vspace{1em}
    \begin{adjustwidth}{0em}{3em}
	    \begin{itemize}
	    	\item[\cite{MAES-24}] J.~Maes, D.~De~Gusem, I.~Lateur, J.~Leliaert, A.~Kurenkov, and B.~Van~Waeyenberge.
	    	\newblock The design, verification, and applications of Hotspice: a Monte Carlo simulator for artificial spin ice.
	    	\newblock \emph{ArXiV}, arXiv:\penalty0 2409.05580, 2024.
	    \end{itemize}
    \end{adjustwidth}
    \vspace{1em}
    \begin{center}
        \centering\rule{0.6\linewidth}{0.4pt}
    \end{center}
    \vspace{1em}
\end{adjustwidth}

To assess the potential of \xref{Reservoir Computing} in (perpendicular-anisotropy) \xref{Artificial Spin Ice}, simulations must be performed to efficiently explore the impact of system parameters on performance.
Nanomagnetic systems are often simulated using micromagnetic codes, such as the finite-difference-based \mumax~\cite{mumax3} and \oommf~\cite{OOMMF} or the finite-element-based \nmag~\cite{Nmag}, which capture the magnetization dynamics of individual nanomagnets in great detail. \par

However, the time between successive switches of a nanomagnet is not necessarily similar to the timescale of micromagnetics: when the simulated time extends beyond several microseconds, simulating even a modest number of magnets -- on the order of several dozen -- becomes computationally unfeasible~\cite{leo2021chiral}. % Q: is it ok to just copy sentences or even paragraphs from my paper?
Furthermore, the determination of RC metrics requires applying many input bits to the system to get a statistically valid result, thereby requiring an even greater number of switches.
It is clear that micromagnetic simulations are therefore ill-suited for our intended purposes. \par

To address these limitations, specialized ASI simulation tools have been developed, such as the flatspin simulator~\cite{flatspin}, which implements deterministic spin flipping via a Stoner-Wohlfarth model~\cite{StonerWohlfarth2008}.
Using such higher-level approximations enables the study of collective behavior in much larger systems and over far longer timescales than is feasible with micromagnetic codes, though at the cost that the internal magnetization structure of individual nanomagnets is no longer simulated in detail.
Additionally, Monte Carlo methods are often used to simulate spin ices, including ASI, but these are typically specialized to a select few lattice geometries and often only account for nearest-neighbor interactions, whose strength is often arbitrarily set or calculated separately using micromagnetic codes.~\cite{MeltingASI,sklenar2019field,gilbert2014emergent,zhang2013crystallites} \par % REFS: 'gilbert2014emergent': MC sims based on a vertex model and interacting magnetic charges. 'zhang2013crystallites': uses monopoles and NN couplings to model kagome ASI with Metropolis and loop update. 'moller2006artificial': bit broader using dipolar interaction, though seemingly still only for nearest neighbors. 'mengotti2011kagome' use a full dipole model with Ewald summation for PBC. 'lou2023competing': dipole model for half-occupation IP Ising. 'sendetskyi2019continuous': dipole model for square ASI. 'EngineeringRelaxationComputation': KMC on dipole model, seemingly for square arrays. 'sklenar2019field': NN interactions calculated by mumax on quadrupole lattice. 'MeltingASI': 16-vertex ice model

Our goal was to blend these two approaches, resulting in \hotspice{}: a versatile Monte Carlo simulator meant to capture ASI physics with minimal arbitrary parameters, allowing various lattice configurations to be evaluated.
This software approximates each single-domain nanomagnet as a single Ising spin, associating energies with its various states and accounting for the magnetostatic interaction between all magnets.
In this chapter, we discuss several model variants to assess their accuracy in simulating the behavior of ASI.
These variants differ in their calculation of the magnetostatic interactions, the use of symmetric versus asymmetric energy barriers, and their choice of update algorithms.
A summary of the most important aspects of \hotspice is given in~\cite{MAES-24}, some of which will be repeated in this chapter while further detailing several aspects of the implementation and related considerations.

\section{Model}

\xfig[1.0]{2_Hotspice/ASIs.pdf}{\label{fig:2:ASIs}Predefined artificial spin ice (ASI) lattices available in \hotspice{}. The unit cell of each lattice is delineated by a central grey rectangle. The red indicator defines the lattice parameter $a$. In the Ising approximation, the magnetization of in-plane magnets (left) aligns along the major axis of the depicted ellipses. Out-of-plane magnets (right) are illustrated as circles.}\\

\section{Energy calculation}
\subsection{Energy terms}
\subsection{Finite-size correction for magnetostatic energy}
\subsubsection{Second-order correction for dipoles}
\subsubsection{Dumbbell model}
\subsubsection{Comparison}
\subsection{Effective energy barrier}
\subsubsection{Intrinsic barrier from shape anisotropy}
\subsubsection{Mean-barrier approximation} % and relevant choices with discontinuities
\subsubsection{Asymmetric barrier}
\subsubsection{Exact solution} % OOP only

\section{Dynamics}
\subsection{N\'eel relaxation: temporal evolution}
\subsection{Metropolis-Hastings: sampling equilibrium states}
% TODO: decide whether to talk about nomenclature details etc. here, or in the introduction.
\subsection{Other Monte Carlo algorithms} % Not implemented, explain why Wolff could be useful but why it's not in Hotspice

\section{Implementation details}
% TODO: this is placeholder text.
Hotspice is written in Python 3.10, and can choose to calculate on either the CPU or GPU.
CuPy v11.4~\cite{CuPy} is used for GPU-accelerated array manipulation, otherwise NumPy and SciPy are used for the CPU.
When writing code for the GPU, it is important to keep the \href{https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/index.html}{Cuda best practices} in mind.
Unfortunately, I only found this page after one year of Hotspice development *shrug*.
Another Python package for parallel programming is the \python{cuNumeric} package by Nvidia, which is also designed to be a drop-in \python{numpy} replacement but supports multiple GPUs, which can be useful for very large simulations that do not fit into the memory of a single GPU.
There is also the \code{nvc++} compiler but this is for Cython code. \par
\subsection{API} % Structure of Hotspice, explain all modules
\subsubsection{ASI}
\subsubsection{RC}
\subsection{Performance} % Several factors impacting performance, explain by using that one graph
\subsubsection{GPU vs. CPU}
\subsubsection{Kernels} % If not yet explained in detail earlier, talk about the perpendicular kernel etc. here
\paragraph{Numerical error with cut-off kernel}
\subsubsection{Multi-switching in Metropolis-Hastings}
\paragraph{Minimal distance between sampled magnets} % Derive equation
\paragraph{Poisson disc}
\paragraph{Grid-select}
\paragraph{Hybrid grid-poisson}
\subsubsection{RNG} % Little to no impact iirc, can be omitted probably
\subsection{Advantages and disadvantages of this approach} % Hindsight is 20/20
\subsubsection{Grid}
\subsubsection{Input/output RC}

\section{Verification} % See paper
\subsection{Hexagon}
\subsection{Non-interacting spin ensemble}
\subsection{Exchange-coupled OOP square system}
\subsubsection{Critical slowing down}
\subsection{Exchange- and magnetostatically-coupled OOP square system}
\subsection{Square-to-pinwheel transition angle}
