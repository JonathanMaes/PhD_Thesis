\chapter{Methods: ``\hotspice'' simulator for ASI}\label{ch:Hotspice}
% \glijbaantje{It's not a bug, it's a feature.}{Someone}

\begin{adjustwidth}{2em}{2em} % TODO END: update once published.
    \begin{center}
        \textbf{Material from this chapter has also been published in:} \\
    \end{center}
    \vspace{1em}
    \begin{adjustwidth}{0em}{3em}
	    \begin{itemize}
	    	\item[\cite{MAES-24}] J.~Maes, D.~De~Gusem, I.~Lateur, J.~Leliaert, A.~Kurenkov, and B.~Van~Waeyenberge.
	    	\newblock The design, verification, and applications of Hotspice: a Monte Carlo simulator for artificial spin ice.
	    	\newblock \emph{ArXiV}, arXiv:\penalty0 2409.05580, 2024.
	    \end{itemize}
    \end{adjustwidth}
    \vspace{0.5em}
    \begin{center}
        \centering\rule{0.7\linewidth}{0.4pt}
    \end{center}
    \vspace{.5em}
    \begin{center}
    	The \hotspice simulator discussed in this chapter\\
    	is open-source and available on \href{https://github.com/bvwaeyen/Hotspice}{GitHub}. \\
    \end{center}
    %\vspace{0.5em}
    \begin{center}
    \centering\rule{0.7\linewidth}{0.4pt}
    \end{center}
    \vspace{1em}
\end{adjustwidth}

To assess the potential of \xref{Reservoir Computing} in (perpendicular-anisotropy) \xref{Artificial Spin Ice}, as is the main topic of this thesis, a simulation framework is needed that allows efficient exploration of the impact that various system parameters and input methods have on the reservoir performance. \\\par

Nanomagnetic systems are often simulated using micromagnetic codes, such as the finite-difference-based \mumax~\cite{mumax3} and \oommf~\cite{OOMMF} or the finite-element-based \nmag~\cite{Nmag}, which capture the magnetization dynamics of individual nanomagnets in great detail. \par
However, the time between successive switches of a nanomagnet is not necessarily similar to the timescale of micromagnetics. Furthermore, determining RC metrics requires applying many input cycles -- on the order of 100 for the task-agnostic metrics -- to get a statistically valid result. In this timeframe, many switches occur. When the simulated time extends beyond several microseconds, simulating even a modest number of magnets -- on the order of several dozen -- becomes computationally unfeasible~\cite{leo2021chiral}. It is clear that micromagnetic simulations are therefore too detailed for our intended purposes. \\\par

To address these limitations, specialized ASI simulation tools have been developed, such as the flatspin simulator~\cite{flatspin}, which implements deterministic spin flipping via a Stoner-Wohlfarth model~\cite{StonerWohlfarth2008}.
Using such higher-level approximations enables the study of collective behaviour in much larger systems and over far longer timescales than is feasible with micromagnetic codes, though at the cost that the internal magnetization structure of individual nanomagnets is no longer simulated in detail.
Additionally, Monte Carlo methods are often used to simulate spin ices, including ASI, but these are typically specialized to a select few lattice geometries and often only account for nearest-neighbour interactions, whose strength is often arbitrarily set or calculated separately using micromagnetic codes.~\cite{MeltingASI,sklenar2019field,gilbert2014emergent,zhang2013crystallites} \\\par % REFS: 'gilbert2014emergent': MC sims based on a vertex model and interacting magnetic charges. 'zhang2013crystallites': uses monopoles and NN couplings to model kagome ASI with Metropolis and loop update. 'moller2006artificial': bit broader using dipolar interaction, though seemingly still only for nearest neighbors. 'mengotti2011kagome' use a full dipole model with Ewald summation for PBC. 'lou2023competing': dipole model for half-occupation IP Ising. 'sendetskyi2019continuous': dipole model for square ASI. 'EngineeringRelaxationComputation': KMC on dipole model, seemingly for square arrays. 'sklenar2019field': NN interactions calculated by mumax on quadrupole lattice. 'MeltingASI': 16-vertex ice model

Our goal was to blend these two approaches, resulting in \hotspice: a versatile Monte Carlo simulator meant to capture ASI physics with minimal arbitrary parameters, allowing various lattice configurations to be evaluated.
This software approximates each single-domain nanomagnet as a single Ising spin, associating energies with its various states and accounting for the magnetostatic interaction between all magnets.
In this chapter, we discuss several model variants to assess their accuracy in simulating the behaviour of ASI.
These variants differ in their calculation of the magnetostatic interactions, the use of symmetric versus asymmetric energy barriers, and their choice of update algorithms. \\\par

A summary of the most important aspects of \hotspice is given in~\cite{MAES-24}, some of which will be repeated in this chapter while further detailing several aspects of the implementation and related considerations.

\section{Model}
Because the magnetization in a nanomagnet prefers to align along the fixed easy axis of its geometry, it is natural to use an Ising-like approximation where the position $\vb{r}_i$, axis $\vb{u}_i$, and size of magnetic moment\footnote{
	The size of the magnetic moment $\mu_i$ corresponds to the total ground state magnetic moment $\abs{\int_{\Omega_i} \vb{M}(\vb{r})d\vb{r}}$, with $\Omega_i$ the shape of magnet $i$ and $\vb{M}(\vb{r})$ its magnetization in the twofold degenerate ground state. Due to edge relaxation effects, this value is slightly smaller than $M_\mathrm{sat} V_i$.
} $\mu_i$ of each magnet are fixed, allowing the magnets to only switch between the `up' and `down' states.
Thus, the total magnetic moment vector of magnet $i$ can be expressed as $\vb{\mu}_i = s_i \mu_i \vb{u}_i$, where $s_i = \pm 1$ and $\abs{\vb{u}_i} = 1$. \par

The switching rate between these states is determined by the temperature $T$ and the effective energy barrier $\widetilde{E_\mathrm{B}}$ separating them.
A canonical ensemble is used where magnets are considered in contact with a heat bath of temperature $T_i$.
For an isolated nanomagnet, the energy barrier $E_\mathrm{B} = K_\mathrm{u} V$\footnote{
	This is valid for switching by coherent rotation. Similar to the calculation of $\mu$, edge relaxation effects may cause the effective volume to be slightly smaller.
} originates from its uniaxial shape anisotropy $K_\mathrm{u}$.
Interactions with other magnets or external fields modify the energy landscape, leading to an effective barrier $\widetilde{E_\mathrm{B}}$.~\cite{leo2021chiral}
\hotspice allows each magnet to have a unique magnetic moment size $\mu_i$, temperature $T_i$ and energy barrier $E_{\mathrm{B},i}$.
This enables, for instance, modelling some of the disorder due to lithographic variations by assigning a different shape anisotropy to each magnet, typically sampled from a Gaussian distribution with mean $E_\mathrm{B}$ and standard deviation $\sigma(E_\mathrm{B})$. \\\par

Due to the periodic nature of many ASI lattices, \hotspice chooses to perform the simulation on a rectilinear grid, the benefits of which will be discussed in~\cref{sec:2:Implementation}.
Each grid point may or may not contain a magnet, and the magnets must either all be of the IP type, or all OOP.
Even though this implementation does not allow complete freedom in the placement of magnets, many popular ASI lattices can be constructed in this manner. \par
\cref{fig:2:ASIs} showcases the 12 lattices that \hotspice provides out-of-the-box. The two variants of pinwheel and square lattices (diamond/lucky-knot and closed/open) correspond to a global \ang{45} rotation of the entire lattice, which due to the rectangular simulation area of the underlying grid results in different boundaries and a different unit cell.
Some other relations exist between the lattices in the figure: the magnets of the OOP lattices (i)-(l) are positioned at the vertices where magnets meet in the respective IP lattices (e)-(h), and the pinwheel lattices (a) and (b) are equal to the square lattices (c) and (d), respectively, but with each magnet rotated \ang{45}. \\\par

\xfig[1.0]{2_Hotspice/ASIs.pdf}{
	\label{fig:2:ASIs}Predefined artificial spin ice (ASI) lattices available in \hotspice{}. The unit cell of each lattice is delineated by a central dark grey rectangle. The red indicator defines the lattice parameter $a$. In the Ising approximation, the magnetization of in-plane magnets (top) aligns along the major axis of the depicted ellipses. Out-of-plane magnets (bottom) are illustrated as circles.
}


\section{Energy calculation}
\subsection{Energy terms}
\subsection{Finite-size correction for magnetostatic energy}
\subsubsection{Second-order correction for dipoles}
\subsubsection{Dumbbell model}
\subsubsection{Comparison}
\subsection{Effective energy barrier}
\subsubsection{Intrinsic barrier from shape anisotropy}
\subsubsection{Mean-barrier approximation} % and relevant choices with discontinuities
\subsubsection{Asymmetric barrier}
\subsubsection{Exact solution} % OOP only

\section{Dynamics}
\subsection{N\'eel relaxation: temporal evolution}
\subsection{Metropolis-Hastings: sampling equilibrium states}
% TODO: decide whether to talk about nomenclature details etc. here, or in the introduction.
\subsection{Other Monte Carlo algorithms} % Not implemented, explain why Wolff could be useful but why it's not in Hotspice

\section{Implementation details}\label{sec:2:Implementation}
% TODO: this is placeholder text.
Hotspice is written as a Python 3.10 module.
It can calculate on either the CPU or GPU, though this choice must be made before the \hotspice module is loaded in a Python script.
CuPy v11.4~\cite{CuPy} is used for GPU-accelerated array manipulation, otherwise NumPy and SciPy are used for calculations on the CPU. \par
\subsection{API} % Structure of Hotspice, explain all modules (core, ASI, energies, (config? with GPU), io, experiments, gui and mostly deprecated plottools, utils but only those relevant to users)
\subsubsection{ASI}
Several ASIs are defined in the \python{hotspice.ASI} module.
All of these take two positional arguments: \python{hotspice.ASI.<ASI_name>(a, n, **kwargs)}.
The first argument is the lattice parameter, as defined in~\cref{fig:2:ASIs}.
The second argument is the size of the underlying grid (one can also specify \python{nx} and \python{ny} separately).
For the predefined lattices in the \python{hotspice.ASI} module, these two parameters are enough information to create a rudimentary ASI.
To create a custom ASI, one should inherit from the \python{hotspice.ASI.IP_ASI} or \python{hotspice.ASI.OOP_ASI} classes.

\subsubsection{RC}
\subsection{Performance} % Several factors impacting performance, explain by using that one graph
\subsubsection{GPU vs. CPU}
\subsubsection{Kernels} % If not yet explained in detail earlier, talk about the perpendicular kernel etc. here
\paragraph{Numerical error with cut-off kernel}
\subsubsection{Multi-switching in Metropolis-Hastings}
\paragraph{Minimal distance between sampled magnets} % Derive equation
\paragraph{Poisson disc}
\paragraph{Grid-select}
\paragraph{Hybrid grid-poisson}
\subsubsection{RNG} % Little to no impact iirc, can be omitted probably
\subsection{Advantages and disadvantages of this approach} % Hindsight is 20/20
\subsubsection{Grid}
\subsubsection{Input/output RC}

\section{Verification} % See paper
\subsection{Hexagon}
\subsection{Non-interacting spin ensemble}
\subsection{Exchange-coupled OOP square system}
\subsubsection{Critical slowing down}
\subsection{Exchange- and magnetostatically-coupled OOP square system}
\subsection{Square-to-pinwheel transition angle}
